# ERC-721 的合约解析

## ERC721 的接口解析

```javascript
pragma solidity ^0.8.0;

import "../../utils/introspection/IERC165.sol";

interface IERC721 is IERC165 {
   
    event Transfer(address indexed from, address indexed to, uint256 indexed tokenId);

    event Approval(address indexed owner, address indexed approved, uint256 indexed tokenId);
    
    event ApprovalForAll(address indexed owner, address indexed operator, bool approved);

    function balanceOf(address owner) external view returns (uint256 balance);

    function ownerOf(uint256 tokenId) external view returns (address owner);

    function safeTransferFrom(address from, address to, uint256 tokenId) external;

    function transferFrom(address from, address to, uint256 tokenId) external;

    function approve(address to, uint256 tokenId) external;

    function getApproved(uint256 tokenId) external view returns (address operator);

    function setApprovalForAll(address operator, bool _approved) external;

    function isApprovedForAll(address owner, address operator) external view returns (bool);

    function safeTransferFrom(address from, address to, uint256 tokenId, bytes calldata data) external;
}
```

- **Transfer**

  ```javascript
  event Transfer(address indexed from, address indexed to, uint256 indexed tokenId);
  ```

  该事件旨在实现对 NFT 所有权的变更。我们会在 NFT 的创建和销毁时触发，当然存在例外，创建合约的时候，不需要 Transfer 也可以创建和分配 NFT 。

- **Approval**

  ```javascript
  event Approval(address indexed owner, address indexed approved, uint256 indexed tokenId);
  ```

  该事件在 NFT 的 approved address 变更或重新确认时被触发。zero address 代表没有 approved address 。

  当一个 Transfer 事件发生时，approved address 会被重置为 none 。

- **ApprovalForAll**

  ```javascript
  event ApprovalForAll(address indexed owner, address indexed operator, bool approved);
  ```

  该事件在 operator 被授权或撤权时触发。operator 可以管理 owner 的所有 NFT 。

- **balanceOf**

  ```javascript
  function balanceOf(address owner) external view returns (uint256 balance);
  ```

  该函数定义了计数 owner 名下的所有 NFT 。将 NFT 分配给无效地址是一个无效的操作。同时当我们在查询无效地址的时候，函数抛出异常。参数是我们需要查询的地址，返回的是 NFT 数量，可能是 0 。

- **ownerOf**

  ```javascript
  function ownerOf(uint256 _tokenId) external view returns (address);
  ```

  该函数定义了获取 NFT 所有者的方法。参数 _tokenId 是 NFT 的标识符。该函数返回的是 owner 地址。
  
- **safeTransferFrom**

  ```ja
  function safeTransferFrom(address from, address to, uint256 tokenId, bytes calldata data) external;
  ```

  该函数的定义是将 NFT 的所有权从一个地址转移到另一个地址。
  抛出异常的情况包括：

  - from 不是当前所有者
  - to 是无效地址
  - tokenId 不是有效 NFT

  当转移完成，函数会校验_to 是不是一个合约。
  //如果是，就会使用_to 来调用onERC721Received 方法，
  //并且这个方法，在返回值不是 bytes4(keccak256("onERC721Received(address,address,uint256,bytes)")) 时抛出异常。
  // _from 是NFT当前所有者，
  // _to 是新所有者，
  // _tokenId 是要被转移的NFT ，
  // data是没有特定格式的数据，用来sent in call to `_to`

- **safeTransferFrom**

  ```javascript
  function safeTransferFrom(address _from, address _to, uint256 _tokenId) external;
  ```

  

- **transferFrom**

  ```javascript
  function transferFrom(address from, address to, uint256 tokenId) external;
  ```

  转移NFT所有权。
  //调用方有责任检查 _to 是否能够有效接收NFT，如果无作为可能会导致永久丢失。
  //抛出异常：当msg.sender不是当前owner，不是approved address，不是authorized operator。
  //三个参数任一无效，则抛出异常。

- **approve**

  ```javascript
  function approve(address to, uint256 tokenId) external;
  ```

  为NFT设置或重新确认approved address。
  //zero address代表没有approved address。
  //抛出异常：当msg.sender不是当前owner，不是approved address，不是authorized operator。
  //_approved 将被设为owner的角色。
  //_tokenId 当前被操作的币。

- **getApproved**

  ```javascript
  function getApproved(uint256 tokenId) external view returns (address operator);
  ```

  获取单个NFT的approved address。
  //抛出异常：_tokenId无效时。
  //_tokenId指代哪个币。
  //返回approved address

- **setApprovalForAll**

  ```javascript
  function setApprovalForAll(address operator, bool _approved) external;
  ```

  该函数定义了授权或撤销权利，对第三方 operator ，对 msg.sender 所有资产的操作的权利。
  在函数的实现中我们会触发 [ApprovalForAll](#ApprovalForAll) 事件。
  //合约必须允许每个owner有多个operator。
  //参数 _operator 添加到authorized operators里面。
  //参数bool值，true表示允许，false表示撤销。

- **isApprovedForAll**

  ```javascript
  function isApprovedForAll(address owner, address operator) external view returns (bool);
  ```

  查询address是否是另一个address的authorized operator 。
  //interfaceID是接口标识符，（ERC-165中规定的）。
  //ERC-165中规定了，对接口的鉴别。
  //返回值为true，代表合约实现了interfaceID这个接口。并且`interfaceID` 不是 0xffffffff。
  //false代表没实现。

- 





## Reference

1. [OpenZeppelin‘s ERC721 implement](https://github.com/OpenZeppelin/openzeppelin-contracts/tree/master/contracts/token/ERC721)
2. [ERC721协议详解 --Solidity](https://studygolang.com/articles/17087)
3. [OpenZeppelin's ERC721 Docs](https://docs.openzeppelin.com/contracts/4.x/erc721)



id: 0acc5a51d81c48bda62cea6aa7880bb6
parent_id: 5b69a37738b147169e0b2242e5a03738
created_time: 2021-03-30T06:14:26.638Z
updated_time: 2021-03-30T16:11:48.507Z
is_conflict: 0
latitude: 0.00000000
longitude: 0.00000000
altitude: 0.0000
author: 
source_url: 
is_todo: 0
todo_due: 0
todo_completed: 0
source: joplin-desktop
source_application: net.cozic.joplin-desktop
application_data: 
order: 0
user_created_time: 2021-03-30T06:14:26.638Z
user_updated_time: 2021-03-30T16:11:48.507Z
encryption_cipher_text: 
encryption_applied: 0
markup_language: 1
is_shared: 0
type_: 1